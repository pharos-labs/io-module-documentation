# RDM Discovery - Version 2.0.1.BETA5

[//]: # (THIS IS WHAT A COMMENT LOOKS LIKE)

[//]: # (Properties should be surrounded by eg. *Property Name*)
[//]: # (Values and options should be surrounded by eg. <code>Value</code>)

<style type="text/css">
.formattedTable { background-color:#eee; }
.formattedTable th { background-color:#000; color:white; width:50%; }
.formattedTable td, .myTable th { padding:5px; border:1px solid #000; }
</style>

## Module Summary

Discovers RDM-enabled fixtures and notifies of changes, including newly discovered, re-discovered, and missing fixtures.

## Module Status

[//]: # (**Note:** Please be aware that this is an BETA version of this IO Module which has not yet been fully tested. This is for evaluation purposes.)

**Note:** Please be aware that this is an BETA version of this IO Module which has not yet been fully tested.

### Known issues and limitations
#### Designer v2.9.2
* &nbsp; [MAG-11352] The controller _may_ unexpectedly reboot on the first discovery run after upload, subsequent discoveries operate without failure

#### VLC/Atlas hardware
* &nbsp; RDM Is not supported on these hardware platforms

If you encounter any issues with this module, or have any feedback regarding its operation, please contact our support team.

### Release Notes

#### Version 2.0.1.BETA5
* &nbsp; Fixed "Patched Fixture Re-Discovered" trigger

#### Version 2.0.1.BETA4
* &nbsp; Added support for Rio G4

#### Version 2.0.1.BETA3
* &nbsp; Removed "Discovery Finished" Trigger
* &nbsp; Added "Discovery Report" trigger, with user customisable report messages
* &nbsp; Removed "Discovery Abort" options

#### Internal

* &nbsp; Module will not see multi-element fixtures as patched (MAG-9286).
* &nbsp; Every command is now broadcast but will only ever run on _all_ controllers or a specific controller (including network primary).
* &nbsp; Network primary handles _all_ Action and Trigger handling (broadcast back when discovery has finished on another controller).

###### Limitations

* &nbsp; Fixture names are currently just placeholders and generated by the module.

*Minor point releases (eg. 1.1.x) will be for small fixes and may not be listed here.*

[//]: # (## Requirements)
[//]: # (Mention any pre-requisites needed before setting up the module in terms of hardware, subscriptions, APIs)

[//]: # (## Configuration)
[//]: # (Mention any setup aspects the user should note that are generally done outside the Designer interface)

**See bottom of readme for full version history.**

## Operation

As of 2.0.1.BETA1, the module can be run on any controller on a network.<br>
Discovery Actions are called from the network-primary. Discovery status and data is fed back to the network primary to handle actions and triggering.<br>
If the network primary is not online, the module will not run.

A non-network-primary controller can only be responsible for universes it has configured and data will only show in the web interface if the *Controller Number* matches the controller number in the network tab.

### Instance Properties

*Controller Number* defines which controller should run the discovery.<br>
A non-network-primary controller can only be responsible for universes it has configured and data will only show in the web interface if the *Controller Number* matches the controller number in the network tab.

Specific universes and ports for supported protocols are specified in the *DMX Ports*, *Art-Net Universes*, *EDN 10 Ports* and *EDN 20* ports in comma-dash range format, eg. <code>0-1, 7, 9, 11-18</code>

<table class="formattedTable">
    <tr>
        <td>DMX</td>
        <td>Physical DMX port, indexed from 1<br>
        eg. <code>1</code> or <code>1-4</code>
        </td>
    </tr>
    <tr>
        <td>Art-Net</td>
        <td>Art-Net Universe as an integer, indexed from 0<br>
        eg. <code>1</code> or <code>0,2,4</code>
        </td>
    </tr>
    <tr>
        <td>EDN 10, EDN 20, Rio G4</td>
        <td>EDN number and ports, indexed from 1<br>
        Formatted as: <code>[EDN number]:[port numbers]</code><br>
        eg. <code>1,2:1-10</code> will be EDNs 1 and 2 and ports 1-10 on both EDNs.
        </td>
    </tr>
</table>

The *Monitored Fixture Range* defines which patched fixtures are to be monitored or leave blank to monitor all patched fixtures on the *Universe/Ports*.

Discovered fixtures not in *Monitored Fixture Range* will be treated as unpatched and therefore fire *Unpatched Fixture Discovered* Triggers.<br
They will still be displayed in the status variables along with all other discovered fixtures.

Checking the *Log Discovered Fixture* checkbox will print out a detailed table of all discovered fixtures, on completion of a *Discover Fixtures* Action.

Checking the *Log Triggers and Conditions* checkbox will provide more detailed logs message for Trigger and Condition matching.<br>
This is for diagnostic purposes and should be disabled during running to maintain controller performance.

*Export Data* defines whether the device information displayed in the status variables and Trigger variables is *As Description* or *As JSON*, *As Lua*  or *None*.

*User Message 1-3* are user customisable messages which can be used by the Trigger *Discovery Report*.<br>
Various arguments can be used, and will be automatically substituted upon use.

<table class="formattedTable">
    <tr>
        <th>Argument</th>
        <th>Details</th>
    </tr>
    <tr>
        <td>\n</td>
        <td>Insert a new line</td>
    </tr>
    <tr>
        <td>\f</td>
        <td>Insert a formfeed</td>
    </tr>
    <tr>
        <td><i>{instanceName}</i></td>
        <td>Module instance name</td>
    </tr>
    <tr>
        <td><i>{controllerNumber}</i></td>
        <td>Controller number associated with the module instance</td>
    </tr>
    <tr>
        <td><i>{controllerName}</i></td>
        <td>Controller name associated with the module instance</td>
    </tr>
    <tr>
        <td><i>{patchedCount}</i></td>
        <td>Number of patched fixtures</td>
    </tr>
    <tr>
        <td><i>{patchedList}</i></td>
        <td>List (Fixture Number) of patched fixtures</td>
    </tr>
    <tr>
        <td><i>{onlinePatchedCount}</i></td>
        <td>Number of patched, online, fixtures</td>
    </tr>
    <tr>
        <td><i>{onlinePatchedList} </i></td>
        <td>List (Fixture Number) of patched, online, fixtures (Fixture Number)</td>
    </tr>
    <tr>
        <td><i>{offlinePatchedCount}</i></td>
        <td>Number of patched, but offline, fixtures</td>
    </tr>
    <tr>
        <td><i>{offlinePatchedList}</i></td>
        <td>List (Fixture Number) of patched, but offline, fixtures (Fixture Number)</td>
    </tr>
    <tr>
        <td><i>{unpatchedCount} </i></td>
        <td>Number of discovered, but unpatched, fixures</td>
    </tr>
    <tr>
        <td><i>{unpatchedList}</i></td>
        <td>List (RDM UID) of discovered, but unpatched, fixures</td>
    </tr>
</table>

#### Status Variables

The IO Modules tab of the web interface provides status variables to shows information about the module and monitor its state.

<table class="formattedTable">
    <tr>
        <th>Variable</th>
        <th>Details</th>
    </tr>
    <tr>
        <td>Universes/Ports</td>
        <td>Description of the instance protocol/ and universes/ports.</td>
    </tr>
    <tr>
        <td>Total Discovered Fixtures</td>
        <td>Total number of fixtures discovered, along with how many are patched and how many are unpatched.</td>
    </tr>
    <tr>
        <td>Warnings</td>
        <td>A description of discovery errors such as fixture patched to the same address and undiscovered patched fixture.</td>
    </tr>
    <tr>
        <td>Online Patched Fixtures</td>
        <td>All patched fixtures on the specified universes that have been discovered.</td>
    </tr>
    <tr>
        <td>Missing Fixture Number</td>
        <td>All patched fixtures on the specified universes that have previously been discovered but are now missing.</td>
    </tr>
    <tr>
        <td>Discovery Status</td>
        <td>A description of the current/last discovery progress eg. waiting to discovery, the current universe, when a discovery is complete or whether it failed.</td>
    </tr>
    <tr>
        <td>Export Data</td>
        <td>Details of all fixtures that have ever been discovered, whether patched or not in the Export Data format.</td>
    </tr>
</table>

### Triggers

#### Discovery Report

Fires once discovery is complete on _all_ defined *Universes*, whether successful or not.<br>
The returned variable is depended on the selected *Report Message*
* *Export Data*: Formatted data for parsing _all_ patched and non-patched fixtures, format type selectable by instance properties.
* *User message 1-3*: Formatted user string, with substituted arguments, message and arguments selectable by instance properties.

<table class="formattedTable">
    <caption>Trigger Variables:</caption>
    <tr>
        <th>#</th>
        <th>Type</th>
        <th>Details</th>
    </tr>
    <tr>
        <td>1</td>
        <td>string</td>
        <td>Report message</td>
    </tr>
</table>

#### Patched Fixture Discovered

Fires when a fixture has been discovered for the first time. A Trigger will be fired _for each_ fixture in the *Fixture Number Range*.

The *Fixture Number Range* must be in the comma-dash range format, eg. <code>0-1, 7, 9, 11-18</code> or if it left blank, any fixture number will match.

<table class="formattedTable">
    <caption>Trigger Variables:</caption>
    <tr>
        <th>#</th>
        <th>Type</th>
        <th>Details</th>
    </tr>
    <tr>
        <td>1</td>
        <td>integer</td>
        <td>Fixture number</td>
    </tr>
    <tr>
        <td>2</td>
        <td>integer</td>
        <td>DMX Address</td>
    </tr>
    <tr>
        <td>3</td>
        <td>string</td>
        <td>RDM UID</td>
    </tr>
    <tr>
        <td>4</td>
        <td>integer</td>
        <td>Footprint</td>
    </tr>
    <tr>
        <td>5</td>
        <td>integer</td>
        <td>Model ID</td>
    </tr>
    <tr>
        <td>6</td>
        <td>string</td>
        <td>Universe description (for reference)</td>
    </tr>
</table>

#### Patched Fixture Re-Discovered

Fires when a fixture has been re-discovered (i.e. not on first discovery), a fixture previously discovered was missing in a previous discovery, but was re-discovered in the most recent discovery. A Trigger will be fired _for each_ fixture in the *Fixture Number Range* that was rediscovered.

The *Fixture Number Range* must be in the comma-dash range format, eg. <code>0-1, 7, 9, 11-18</code> or if it left blank, any fixture number will match.

<table class="formattedTable">
    <caption>Trigger Variables:</caption>
    <tr>
        <th>#</th>
        <th>Type</th>
        <th>Details</th>
    </tr>
    <tr>
        <td>1</td>
        <td>integer</td>
        <td>Fixture number</td>
    </tr>
    <tr>
        <td>2</td>
        <td>integer</td>
        <td>DMX Address</td>
    </tr>
    <tr>
        <td>3</td>
        <td>string</td>
        <td>RDM UID</td>
    </tr>
    <tr>
        <td>4</td>
        <td>integer</td>
        <td>Footprint</td>
    </tr>
    <tr>
        <td>5</td>
        <td>integer</td>
        <td>Model ID</td>
    </tr>
    <tr>
        <td>6</td>
        <td>string</td>
        <td>Universe description (for reference)</td>
    </tr>
</table>

#### Patched Fixture Missing

Fires when a fixture is deemed missing, i.e. has previously been discovered but was not discovered on the most recent discovery.<br>
A Trigger will be fired _for each_ fixture in the *Fixture Number Range*.<br>
_n.b. Discoveries do not currently persist power cycles_

The *Fixture Number Range* must be in the comma-dash range format, eg. <code>0-1, 7, 9, 11-18</code> or if it left blank, any fixture number will match.

<table class="formattedTable">
    <caption>Trigger Variables:</caption>
    <tr>
        <th>#</th>
        <th>Type</th>
        <th>Details</th>
    </tr>
    <tr>
        <td>1</td>
        <td>integer</td>
        <td>Fixture number</td>
    </tr>
    <tr>
        <td>2</td>
        <td>integer</td>
        <td>DMX Address</td>
    </tr>
    <tr>
        <td>3</td>
        <td>string</td>
        <td>RDM UID</td>
    </tr>
    <tr>
        <td>4</td>
        <td>integer</td>
        <td>Footprint</td>
    </tr>
    <tr>
        <td>5</td>
        <td>integer</td>
        <td>Model ID</td>
    </tr>
    <tr>
        <td>6</td>
        <td>string</td>
        <td>Universe description (for reference)</td>
    </tr>
</table>

#### Unpatched Fixture Discovered

Fires when an unpatched fixture has been discovered, whether previously seen or not.<br>
A Trigger will be fired _for each_ fixture, if the fixture address is within the *Start Address Minimum* and *Start Address Maximum* range, and the footprint is between the *Footprint Minimum* and *Footprint Maximum* range.

<table class="formattedTable">
    <caption>Trigger Variables:</caption>
    <tr>
        <th>#</th>
        <th>Type</th>
        <th>Details</th>
    </tr>
    <tr>
        <td>1</td>
        <td>string</td>
        <td>"[unpatched]" (to match order of patched triggers)</td>
    </tr>
    <tr>
        <td>2</td>
        <td>integer</td>
        <td>DMX Address</td>
    </tr>
    <tr>
        <td>3</td>
        <td>string</td>
        <td>RDM UID</td>
    </tr>
    <tr>
        <td>4</td>
        <td>integer</td>
        <td>Footprint</td>
    </tr>
    <tr>
        <td>5</td>
        <td>integer</td>
        <td>Model ID</td>
    </tr>
    <tr>
        <td>6</td>
        <td>string</td>
        <td>Universe description (for reference)</td>
    </tr>
</table>

[//]: # (### Conditions)

[//]: # (#### Conditions Name)
[//]: # (#### Start with a verb such as "Is met when..." or "Returns true if...")

### Actions

#### Discover Fixtures

Sends an RDM discovery on all defined *Universes*.<br>
The response from each will fire the respective Triggers.<br>
Once all discovery is complete, whether successful or not, the *Discovery Report* Trigger will be fired.

## Support

If you encounter any issues with this module, please contact our support team.

[//]: # (### Module Use Example)
[//]: # (If relevant to documentation give examples of module use)

[//]: # (### Further Notes)
[//]: # (Possible location for further notes, may not be used)

### Previous Versions

#### Version 2.0.1.BETA2
* &nbsp; Remove Start/Stop polling actions. Scheduled polling can be performed by real time triggers.
* &nbsp; Working multi-controller discovery.
* &nbsp; Clarified "Discovery Finished" Trigger return variables.
* &nbsp; Fixed "Patched Fixture Missing" trigger.

#### Version 2.0.1.BETA1

* &nbsp; Added multi-controller support so individual controllers can do their own discovery and display their own information (as well as firing triggers on the network primary).
* &nbsp; Added *Controller Number* to the instance property.
* &nbsp; Added support for multiple protocols per module instance (but limited to a controller).
* &nbsp; Removed *Protocol* and *Universe/Ports* and replaced with individual protocol fields.
* &nbsp; Option in *Discovery Finished* to filter by <code>Patched</code> or <code>Unpatched</code> fixtures.
* &nbsp; Added additional Trigger variables for _all_ triggers.
* &nbsp; Re-ordered Trigger variables for consistency across Triggers - see below for new  additional Trigger variables for _all_ triggers.
* &nbsp; sensor_count, current_personality and personality_count now display correct values (in 2.9.BETA4).

#### Version 2.0.DEBUG5

* &nbsp; Removed redundant status variables.
* &nbsp; Added *Total Discovered Fixtures* status variable, including number of patched and unpatched fixtures.
* &nbsp; Renamed *Instance Data* instance property to *Export Data Format*.
* &nbsp; Added *Warnings* status variable to display errors such as fixture patched to the same address and undiscovered patched fixture.
* &nbsp; Merged *Last Discovery Started* and *Last Discovery Finished* status variable to *Discovery Status*.
* &nbsp; More real-time discovery statuses such as the current universe being discovered.
* &nbsp; Added *Abort Discoveries In Progress* option to the *Discover* Action.
* &nbsp; Improved fixture table logging to include fixture name and duplicated patched fixtures.
* &nbsp; Updated export data strings to include UID and name.
* &nbsp; Updated documentation.

#### Version 2.0.BETA2

* &nbsp; Added *Unpatched Fixture Discovered* Trigger.
* &nbsp; General fixes.
* &nbsp; Updated documentation.

#### Version 2.0.BETA1

* &nbsp; Added *Export Data* instance property to display fixture data in description, JSON or Lua format.
* &nbsp; Added more detailed device info (MAG-8901).
* &nbsp; Added *Poll Interval* option (requires further work).
* &nbsp; Added *Start Polling* Action.
* &nbsp; Added *Stop Polling* Action.
* &nbsp; Added *Log Discovered Fixtures* option to instance (Extended logging level).
* &nbsp; Reworked data structure to use store data using UID (internal).
* &nbsp; Added support for duplicate addressed fixtures detection (internal).
* &nbsp; Added fixture and universe iterators (internal).

#### Version 2.0.DEBUG3

* &nbsp; Renamed *Fixture Number Range* to *Monitored Patched Fixtures*.
* &nbsp; Added *Last Discovery Started* status variable.
* &nbsp; Added *Last Discovery Finished* status variable.
* &nbsp; Added *Export Data* status variable with description of both patched and unpatched fixtures.
* &nbsp; Added *Abort All Discovery* Action.
* &nbsp; Fixed Trigger matching.
* &nbsp; Updated documentation.

#### Version 2.0.DEBUG2

* &nbsp; Added *Undiscovered Fixtures* status variable.
* &nbsp; Reformatted status variables to show ranges of fixtures instead of individual numbers.
* &nbsp; Improved Trigger match logging.
* &nbsp; Modified DMX and EDN port numbers so the user-facing port is 1-based.
* &nbsp; Re-named Triggers.

#### Version 2.0.DEBUG1

* &nbsp; Added *Discovery Finished* Trigger.
* &nbsp; Added *Patched Fixture Discovered* Trigger.
* &nbsp; Added *Patch Fixture Re-Discovered* Trigger.
* &nbsp; Added *Patched Fixture Missing* Trigger.
* &nbsp; Added *Discover Fixtures* Action.
* &nbsp; Added status variables for *Online Fixture Numbers* and *Offline Fixture Numbers*.
* &nbsp; Added support for multiple universes.
* &nbsp; Added description handlers.
* &nbsp; Added error checking for invalid universes in description handlers and log.
* &nbsp; Added fixture re-sorting and re-ordering (description handlers and internal).
* &nbsp; Added readme.
